<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Understanding AI Diagnostic Tools: Confusion Matrix</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Source Sans Pro', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.7;
            color: #2e2d29;
            background: linear-gradient(135deg, #8C1515 0%, #820000 100%);
            min-height: 100vh;
        }

        .site-header {
            background: white;
            padding: 12px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .site-header a {
            display: inline-block;
        }

        .site-header img {
            max-width: 50%;
            height: auto;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .viz-row {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }

        .viz-left {
            flex: 1;
            min-width: 0;
        }

        .viz-right {
            flex: 0 0 380px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        h1 {
            color: #8C1515;
            font-size: 2em;
            margin-bottom: 10px;
        }

        h2 {
            color: #2e2d29;
            font-size: 1.4em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #8C1515;
        }

        h3 {
            color: #2e2d29;
            font-size: 1.15em;
            margin: 20px 0 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .authors {
            color: #53565A;
            font-size: 0.95em;
            margin-bottom: 20px;
        }

        .scenario-box {
            background: linear-gradient(135deg, #e5f3f5 0%, #cce7eb 100%);
            border-left: 5px solid #007C92;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .scenario-box h3 {
            color: #007C92;
            margin-top: 0;
        }

        /* Threshold Visualization */
        .threshold-viz-container {
            background: #f7fafc;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
        }

        .distribution-chart {
            position: relative;
            height: 280px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
            overflow: visible;
            margin-top: 30px;
        }

        .chart-area {
            position: relative;
            height: 220px;
            margin: 50px 40px 0 40px;
        }

        .patient-dot {
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .patient-dot:hover {
            transform: translate(-50%, -50%) scale(1.4);
            z-index: 100;
        }

        .patient-dot.has-pneumonia {
            background: #B83A4B;
        }

        .patient-dot.healthy {
            background: #175E54;
        }

        .patient-dot.predicted-positive {
            box-shadow: 0 0 0 3px rgba(184, 58, 75, 0.3), 0 2px 4px rgba(0,0,0,0.2);
        }

        .threshold-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, #620059, #4a0042);
            cursor: ew-resize;
            z-index: 50;
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(98, 0, 89, 0.5);
        }

        .threshold-line::before {
            content: '';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 12px solid #620059;
        }

        .threshold-label {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: #620059;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: bold;
            white-space: nowrap;
        }

        .chart-axis {
            position: absolute;
            bottom: 0;
            left: 40px;
            right: 40px;
            height: 30px;
            border-top: 2px solid #cbd5e0;
        }

        .axis-label {
            position: absolute;
            font-size: 0.8em;
            color: #718096;
            transform: translateX(-50%);
        }

        .axis-title {
            text-align: center;
            font-size: 0.9em;
            color: #4a5568;
            margin-top: 5px;
        }

        .zone-labels {
            position: absolute;
            top: 5px;
            left: 40px;
            right: 40px;
            display: flex;
            justify-content: space-between;
            font-size: 0.75em;
            color: #718096;
        }

        .predicted-negative-zone, .predicted-positive-zone {
            padding: 4px 10px;
            border-radius: 4px;
        }

        .predicted-negative-zone {
            background: rgba(23, 94, 84, 0.1);
        }

        .predicted-positive-zone {
            background: rgba(140, 21, 21, 0.1);
        }

        /* Confusion Matrix Styles */
        .matrix-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .matrix-labels-top {
            display: grid;
            grid-template-columns: 100px 130px 130px;
            gap: 4px;
            margin-bottom: 5px;
        }

        .matrix-labels-top > div {
            text-align: center;
            font-weight: 600;
            font-size: 0.85em;
            color: #4a5568;
        }

        .matrix-row {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 4px;
        }

        .matrix-row-label {
            width: 100px;
            text-align: right;
            padding-right: 10px;
            font-weight: 600;
            font-size: 0.85em;
            color: #4a5568;
        }

        .matrix-cell {
            width: 130px;
            height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .matrix-cell .label {
            font-size: 0.75em;
            opacity: 0.9;
            margin-bottom: 2px;
        }

        .matrix-cell .count {
            font-size: 2em;
            font-weight: bold;
        }

        .matrix-cell .abbrev {
            font-size: 0.8em;
            opacity: 0.8;
        }

        .matrix-cell.tp {
            background: linear-gradient(135deg, #175E54 0%, #279989 100%);
            color: white;
        }

        .matrix-cell.fn {
            background: linear-gradient(135deg, #E98300 0%, #F9A825 100%);
            color: white;
        }

        .matrix-cell.fp {
            background: linear-gradient(135deg, #820000 0%, #8C1515 100%);
            color: white;
        }

        .matrix-cell.tn {
            background: linear-gradient(135deg, #007C92 0%, #4298B5 100%);
            color: white;
        }

        /* Metrics Display */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin: 25px 0;
        }

        .metric-card {
            background: #f7fafc;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
        }

        .metric-card.highlight {
            border-color: #8C1515;
            background: #fef5f5;
        }

        .metric-card .metric-name {
            font-size: 0.8em;
            color: #718096;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .metric-card .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2d3748;
        }

        .metric-card .metric-formula {
            font-size: 0.7em;
            color: #a0aec0;
            margin-top: 5px;
            font-family: monospace;
        }

        /* Legend */
        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .legend-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* Dataset selector */
        .dataset-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .dataset-explanation {
            text-align: center;
            font-size: 0.9em;
            color: #53565A;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 3px solid #8C1515;
        }

        .dataset-btn {
            padding: 10px 20px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .dataset-btn:hover {
            border-color: #8C1515;
            background: #fef5f5;
        }

        .dataset-btn.active {
            border-color: #8C1515;
            background: #8C1515;
            color: white;
        }

        /* Quadrant explanations */
        .quadrant-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .quadrant-card {
            padding: 18px;
            border-radius: 10px;
            color: white;
        }

        .quadrant-card h4 {
            margin-bottom: 8px;
            font-size: 1em;
        }

        .quadrant-card p {
            font-size: 0.9em;
            opacity: 0.95;
            line-height: 1.5;
        }

        .quadrant-card.tp-card { background: linear-gradient(135deg, #175E54 0%, #279989 100%); }
        .quadrant-card.tn-card { background: linear-gradient(135deg, #007C92 0%, #4298B5 100%); }
        .quadrant-card.fp-card { background: linear-gradient(135deg, #820000 0%, #8C1515 100%); }
        .quadrant-card.fn-card { background: linear-gradient(135deg, #E98300 0%, #F9A825 100%); }

        /* Clinical implications */
        .implications-box {
            background: #FFF9E6;
            border: 2px solid #E98300;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .implications-box h3 {
            color: #E98300;
            margin-bottom: 10px;
        }

        /* Instructions */
        .instructions {
            background: #DAD7CB;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
            font-size: 0.95em;
        }

        .instructions strong {
            color: #8C1515;
        }

        /* ROC Curve */
        .roc-container {
            margin-top: 20px;
            text-align: center;
        }

        .roc-container h4 {
            color: #2e2d29;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .roc-chart {
            position: relative;
            display: inline-block;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            margin-bottom: 15px;
        }

        .roc-chart canvas {
            display: block;
        }

        .roc-labels .roc-ylabel {
            position: absolute;
            left: -70px;
            top: 50%;
            transform: rotate(-90deg) translateX(50%);
            font-size: 0.7em;
            color: #53565A;
            white-space: nowrap;
        }

        .roc-labels .roc-xlabel {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7em;
            color: #53565A;
        }

        .auc-display {
            margin-top: 8px;
            font-size: 0.85em;
            color: #53565A;
        }

        .auc-display span {
            font-weight: bold;
            color: #8C1515;
        }

        /* Responsive */
        @media (max-width: 1000px) {
            .viz-row {
                flex-direction: column;
            }

            .viz-right {
                flex: 1;
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .quadrant-grid {
                grid-template-columns: 1fr;
            }

            .matrix-cell {
                width: 100px;
                height: 75px;
            }

            .matrix-cell .count {
                font-size: 1.5em;
            }

            .matrix-row-label, .matrix-labels-top > div {
                font-size: 0.75em;
            }

            .matrix-labels-top {
                grid-template-columns: 80px 100px 100px;
            }

            .matrix-row-label {
                width: 80px;
            }
        }
    </style>
</head>
<body>
    <header class="site-header">
        <a href="https://med.stanford.edu/ai-in-meded.html" target="_blank">
            <img src="logo.png" alt="Stanford Medicine - AI in Medical Education">
        </a>
    </header>
    <div class="container">
        <!-- Header -->
        <div class="card">
            <h1>Evaluating AI Diagnostic Tools</h1>
            <p class="subtitle">Understanding Confusion Matrices for Clinical Decision-Making</p>
            <p class="authors">Vishnu Ravi, MD &bull; Aydin Zahedivash, MD &bull; Alaa Youssef, PhD &bull; Gabriel Tse, MD &bull; Jonathan Chen, MD, PhD</p>

            <div class="scenario-box">
                <h3>Why This Matters</h3>
                <p>AI-powered diagnostic tools are increasingly used in clinical settings. As a clinician, you need to understand how to interpret their performance metrics to make informed decisions about when to trust these tools and how to use them appropriately.</p>
                <p style="margin-top: 10px;">This tutorial uses a <strong>chest X-ray AI for pneumonia detection</strong> as an example. The same principles apply to any diagnostic AI tool.</p>
            </div>
        </div>

        <!-- The Four Outcomes -->
        <div class="card">
            <h2>The Four Possible Outcomes</h2>
            <p>When an AI tool makes a prediction, there are four possible outcomes based on whether the prediction was correct and what the actual condition is:</p>

            <div class="quadrant-grid">
                <div class="quadrant-card tp-card">
                    <h4>True Positive (TP)</h4>
                    <p><strong>AI says:</strong> Pneumonia detected<br>
                    <strong>Reality:</strong> Patient has pneumonia<br>
                    <em>Correct alert — patient receives treatment</em></p>
                </div>
                <div class="quadrant-card fp-card">
                    <h4>False Positive (FP)</h4>
                    <p><strong>AI says:</strong> Pneumonia detected<br>
                    <strong>Reality:</strong> Patient is healthy<br>
                    <em>False alarm — unnecessary treatment</em></p>
                </div>
                <div class="quadrant-card fn-card">
                    <h4>False Negative (FN)</h4>
                    <p><strong>AI says:</strong> No pneumonia<br>
                    <strong>Reality:</strong> Patient has pneumonia<br>
                    <em>Missed case — delayed treatment</em></p>
                </div>
                <div class="quadrant-card tn-card">
                    <h4>True Negative (TN)</h4>
                    <p><strong>AI says:</strong> No pneumonia<br>
                    <strong>Reality:</strong> Patient is healthy<br>
                    <em>Correct clearance — patient reassured</em></p>
                </div>
            </div>
        </div>

        <!-- Interactive Threshold Visualization -->
        <div class="card">
            <h2>Interactive: How Threshold Affects Results</h2>

            <p>The AI assigns each X-ray a <strong>confidence score</strong> (0-100%) indicating how likely pneumonia is present. A <strong>threshold</strong> determines the cutoff: scores above the threshold are flagged as "Pneumonia Detected."</p>

            <div class="instructions">
                <strong>Try it:</strong> Drag the purple threshold line left or right to see how changing the threshold affects the confusion matrix and performance metrics.
            </div>

            <div class="dataset-selector">
                <button class="dataset-btn active" onclick="setDataset('separated', this)">Severe Cases</button>
                <button class="dataset-btn" onclick="setDataset('unseparated', this)">Subtle Cases</button>
                <button class="dataset-btn" onclick="setDataset('imbalanced', this)">Rare Disease</button>
            </div>
            <div class="dataset-explanation" id="datasetExplanation">
                <strong>Severe Cases:</strong> ICU patients with large lobar pneumonia and high fevers. The AI easily distinguishes these obvious cases from healthy patients. This represents ideal conditions — but an AI validated only on severe cases may struggle with your more subtle outpatients.
            </div>

            <div class="viz-row">
                <div class="viz-left">
                    <div class="threshold-viz-container">
                        <div class="distribution-chart" id="distributionChart">
                            <div class="zone-labels">
                                <span class="predicted-negative-zone">← AI predicts: No Pneumonia</span>
                                <span class="predicted-positive-zone">AI predicts: Pneumonia →</span>
                            </div>
                            <div class="chart-area" id="chartArea">
                                <div class="threshold-line" id="thresholdLine">
                                    <div class="threshold-label" id="thresholdLabel">Threshold: 50%</div>
                                </div>
                            </div>
                            <div class="chart-axis">
                                <span class="axis-label" style="left: 0%;">0%</span>
                                <span class="axis-label" style="left: 25%;">25%</span>
                                <span class="axis-label" style="left: 50%;">50%</span>
                                <span class="axis-label" style="left: 75%;">75%</span>
                                <span class="axis-label" style="left: 100%;">100%</span>
                            </div>
                        </div>
                        <p class="axis-title">AI Confidence Score (probability of pneumonia)</p>

                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-dot" style="background: #B83A4B;"></div>
                                Patient with pneumonia
                            </div>
                            <div class="legend-item">
                                <div class="legend-dot" style="background: #175E54;"></div>
                                Healthy patient
                            </div>
                        </div>
                    </div>
                </div>

                <div class="viz-right">
                    <!-- Confusion Matrix -->
                    <div class="matrix-container">
                        <div class="matrix-labels-top">
                            <div></div>
                            <div>AI: Pneumonia</div>
                            <div>AI: No Pneumonia</div>
                        </div>
                        <div class="matrix-row">
                            <div class="matrix-row-label">Actually Has<br>Pneumonia</div>
                            <div class="matrix-cell tp" id="tpCell">
                                <span class="label">True Positive</span>
                                <span class="count" id="tpCount">25</span>
                            </div>
                            <div class="matrix-cell fn" id="fnCell">
                                <span class="label">False Negative</span>
                                <span class="count" id="fnCount">5</span>
                            </div>
                        </div>
                        <div class="matrix-row">
                            <div class="matrix-row-label">Actually<br>Healthy</div>
                            <div class="matrix-cell fp" id="fpCell">
                                <span class="label">False Positive</span>
                                <span class="count" id="fpCount">10</span>
                            </div>
                            <div class="matrix-cell tn" id="tnCell">
                                <span class="label">True Negative</span>
                                <span class="count" id="tnCount">60</span>
                            </div>
                        </div>
                    </div>

                    <!-- ROC Curve -->
                    <div class="roc-container">
                        <h4>ROC Curve</h4>
                        <div class="roc-chart">
                            <canvas id="rocCanvas" width="300" height="240"></canvas>
                            <div class="roc-labels">
                                <span class="roc-ylabel">Recall (TPR)</span>
                                <span class="roc-xlabel">False Positive Rate</span>
                            </div>
                        </div>
                        <div class="auc-display">AUC: <span id="aucValue">0.85</span></div>
                    </div>
                </div>
            </div>

            <!-- Metrics -->
            <div class="metrics-grid">
                <div class="metric-card" id="accuracyCard">
                    <div class="metric-name">Accuracy</div>
                    <div class="metric-value" id="accuracy">85%</div>
                    <div class="metric-formula">(TP+TN) / Total</div>
                </div>
                <div class="metric-card" id="recallCard">
                    <div class="metric-name">Recall</div>
                    <div class="metric-value" id="recall">83%</div>
                    <div class="metric-formula">TP / (TP+FN)</div>
                </div>
                <div class="metric-card" id="fprCard">
                    <div class="metric-name">False Positive Rate</div>
                    <div class="metric-value" id="fpr">14%</div>
                    <div class="metric-formula">FP / (FP+TN)</div>
                </div>
                <div class="metric-card" id="precisionCard">
                    <div class="metric-name">Precision</div>
                    <div class="metric-value" id="precision">71%</div>
                    <div class="metric-formula">TP / (TP+FP)</div>
                </div>
            </div>

            <div class="implications-box">
                <h3>Clinical Interpretation</h3>
                <p id="clinicalInterpretation">
                    With this threshold, the AI correctly classifies <strong id="accuracyText">85%</strong> of all cases (accuracy)
                    and catches <strong id="recallText">83%</strong> of pneumonia cases (recall).
                    However, <strong id="fprText">14%</strong> of healthy patients receive false alarms (false positive rate).
                </p>
            </div>
        </div>

        <!-- Understanding Tradeoffs -->
        <div class="card">
            <h2>The Precision-Recall Tradeoff</h2>

            <p>Notice what happens when you move the threshold:</p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div style="background: #e8f4f2; padding: 20px; border-radius: 10px; border-left: 4px solid #175E54;">
                    <h3 style="color: #175E54; margin-bottom: 10px;">Lower Threshold (←)</h3>
                    <ul style="margin-left: 20px; color: #175E54;">
                        <li>More cases flagged as positive</li>
                        <li><strong>Higher recall</strong> — catch more true pneumonia</li>
                        <li><strong>Higher false positive rate</strong> — more false alarms</li>
                        <li>Fewer missed cases, more unnecessary workup</li>
                    </ul>
                </div>
                <div style="background: #fef5f5; padding: 20px; border-radius: 10px; border-left: 4px solid #8C1515;">
                    <h3 style="color: #8C1515; margin-bottom: 10px;">Higher Threshold (→)</h3>
                    <ul style="margin-left: 20px; color: #820000;">
                        <li>Fewer cases flagged as positive</li>
                        <li><strong>Lower recall</strong> — miss more true pneumonia</li>
                        <li><strong>Lower false positive rate</strong> — fewer false alarms</li>
                        <li>More missed cases, less unnecessary workup</li>
                    </ul>
                </div>
            </div>

            <div class="scenario-box">
                <h3>Clinical Context Matters</h3>
                <p><strong>Emergency screening:</strong> Use a lower threshold. Missing pneumonia in a sick patient (false negative) is dangerous. Accept more false positives that can be ruled out with further testing.</p>
                <p style="margin-top: 10px;"><strong>Confirmatory testing:</strong> Use a higher threshold. You want high confidence before initiating aggressive treatment. False positives lead to unnecessary interventions.</p>
            </div>
        </div>

        <!-- Key Terms Reference -->
        <div class="card">
            <h2>Quick Reference: Key Metrics</h2>

            <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                <thead>
                    <tr style="background: #edf2f7;">
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #cbd5e0;">Metric</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #cbd5e0;">Question It Answers</th>
                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #cbd5e0;">Formula</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;"><strong>Accuracy</strong></td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">Of all cases, how many did the AI classify correctly?</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; font-family: monospace;">(TP + TN) / Total</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;"><strong>Recall</strong><br><span style="color: #718096; font-size: 0.85em;">(Sensitivity, TPR)</span></td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">Of all patients WITH pneumonia, how many did the AI catch?</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; font-family: monospace;">TP / (TP + FN)</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;"><strong>False Positive Rate</strong><br><span style="color: #718096; font-size: 0.85em;">(FPR)</span></td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">Of all HEALTHY patients, how many did the AI incorrectly flag?</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; font-family: monospace;">FP / (FP + TN)</td>
                    </tr>
                    <tr>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;"><strong>Precision</strong><br><span style="color: #718096; font-size: 0.85em;">(PPV)</span></td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">If AI says "pneumonia," how likely is it actually pneumonia?</td>
                        <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; font-family: monospace;">TP / (TP + FP)</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Patient data for different datasets
        const datasets = {
            separated: {
                // Clear separation - pneumonia patients have higher scores
                pneumonia: [
                    55, 60, 62, 65, 68, 70, 72, 74, 76, 78,
                    80, 82, 84, 85, 86, 87, 88, 89, 90, 91,
                    92, 93, 94, 95, 96, 97, 98, 98, 99, 99
                ],
                healthy: [
                    2, 4, 6, 8, 10, 12, 14, 16, 18, 20,
                    22, 24, 26, 28, 30, 32, 34, 36, 38, 40,
                    42, 44, 45, 46, 47, 48, 49, 50, 51, 52,
                    10, 15, 20, 25, 28, 30, 32, 35, 38, 40,
                    5, 8, 12, 18, 22, 25, 28, 32, 35, 38,
                    3, 7, 11, 15, 19, 23, 27, 31, 35, 39,
                    6, 9, 13, 17, 21, 24, 29, 33, 37, 41
                ]
            },
            unseparated: {
                // High overlap - nearly indistinguishable distributions
                pneumonia: [
                    25, 30, 32, 35, 38, 40, 42, 45, 48, 50,
                    52, 55, 58, 60, 62, 65, 68, 70, 72, 75,
                    35, 40, 45, 50, 55, 60, 65, 70, 55, 60
                ],
                healthy: [
                    20, 25, 28, 32, 35, 38, 42, 45, 48, 50,
                    52, 55, 58, 60, 62, 65, 68, 70, 72, 74,
                    30, 35, 40, 45, 50, 55, 60, 65, 70, 72,
                    25, 30, 35, 40, 45, 50, 55, 60, 65, 70,
                    28, 33, 38, 43, 48, 53, 58, 63, 68, 70,
                    32, 38, 44, 50, 56, 62, 68, 72, 75, 78,
                    22, 28, 34, 40, 46, 52, 58, 64, 70, 74
                ]
            },
            imbalanced: {
                // Few positive cases - only 10 pneumonia patients out of 100
                // Moderate separation - similar to real clinical scenarios
                pneumonia: [
                    45, 52, 58, 63, 68, 72, 76, 80, 85, 90
                ],
                healthy: [
                    5, 8, 12, 15, 18, 22, 25, 28, 32, 35,
                    10, 14, 18, 22, 26, 30, 34, 38, 42, 46,
                    15, 20, 25, 30, 35, 40, 45, 50, 55, 60,
                    12, 17, 22, 27, 32, 37, 42, 47, 52, 57,
                    8, 13, 18, 23, 28, 33, 38, 43, 48, 53,
                    6, 11, 16, 21, 26, 31, 36, 41, 46, 51,
                    10, 15, 20, 25, 30, 35, 40, 45, 50, 55,
                    7, 12, 17, 22, 27, 32, 37, 42, 47, 52,
                    9, 14, 19, 24, 29, 34, 39, 44, 49, 54
                ]
            }
        };

        let currentDataset = 'separated';
        let threshold = 50;
        let patients = [];

        // Initialize
        function init() {
            generatePatients();
            setupThresholdDrag();
            updateVisualization();
        }

        function generatePatients() {
            const chartArea = document.getElementById('chartArea');
            // Clear existing patients
            document.querySelectorAll('.patient-dot').forEach(el => el.remove());

            patients = [];
            const data = datasets[currentDataset];

            // Add pneumonia patients
            data.pneumonia.forEach((score, i) => {
                patients.push({
                    score: score,
                    hasPneumonia: true,
                    yOffset: 20 + (i % 8) * 22 + Math.random() * 10
                });
            });

            // Add healthy patients
            data.healthy.forEach((score, i) => {
                patients.push({
                    score: score,
                    hasPneumonia: false,
                    yOffset: 20 + (i % 8) * 22 + Math.random() * 10
                });
            });

            // Create dots
            patients.forEach((patient, i) => {
                const dot = document.createElement('div');
                dot.className = `patient-dot ${patient.hasPneumonia ? 'has-pneumonia' : 'healthy'}`;
                dot.style.left = `${patient.score}%`;
                dot.style.top = `${patient.yOffset}px`;
                dot.dataset.index = i;
                dot.title = `Score: ${patient.score}%\n${patient.hasPneumonia ? 'Has pneumonia' : 'Healthy'}`;
                chartArea.appendChild(dot);
            });
        }

        function setupThresholdDrag() {
            const thresholdLine = document.getElementById('thresholdLine');
            const chartArea = document.getElementById('chartArea');
            let isDragging = false;

            thresholdLine.style.left = `${threshold}%`;

            const startDrag = (e) => {
                isDragging = true;
                e.preventDefault();
            };

            const doDrag = (e) => {
                if (!isDragging) return;

                const rect = chartArea.getBoundingClientRect();
                const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                let x = ((clientX - rect.left) / rect.width) * 100;
                x = Math.max(5, Math.min(95, x));

                threshold = Math.round(x);
                thresholdLine.style.left = `${threshold}%`;
                updateVisualization();
            };

            const endDrag = () => {
                isDragging = false;
            };

            thresholdLine.addEventListener('mousedown', startDrag);
            thresholdLine.addEventListener('touchstart', startDrag);
            document.addEventListener('mousemove', doDrag);
            document.addEventListener('touchmove', doDrag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);

            // Also allow clicking anywhere on the chart
            chartArea.addEventListener('click', (e) => {
                if (e.target === chartArea || e.target.classList.contains('patient-dot')) {
                    const rect = chartArea.getBoundingClientRect();
                    let x = ((e.clientX - rect.left) / rect.width) * 100;
                    x = Math.max(5, Math.min(95, x));
                    threshold = Math.round(x);
                    thresholdLine.style.left = `${threshold}%`;
                    updateVisualization();
                }
            });
        }

        function updateVisualization() {
            // Update threshold label
            document.getElementById('thresholdLabel').textContent = `Threshold: ${threshold}%`;

            // Calculate confusion matrix
            let tp = 0, fn = 0, fp = 0, tn = 0;

            patients.forEach((patient, i) => {
                const predictedPositive = patient.score >= threshold;
                const dot = document.querySelector(`.patient-dot[data-index="${i}"]`);

                if (patient.hasPneumonia) {
                    if (predictedPositive) {
                        tp++;
                    } else {
                        fn++;
                    }
                } else {
                    if (predictedPositive) {
                        fp++;
                    } else {
                        tn++;
                    }
                }

                // Update dot appearance
                if (dot) {
                    dot.classList.toggle('predicted-positive', predictedPositive);
                }
            });

            // Update confusion matrix display
            document.getElementById('tpCount').textContent = tp;
            document.getElementById('fnCount').textContent = fn;
            document.getElementById('fpCount').textContent = fp;
            document.getElementById('tnCount').textContent = tn;

            // Calculate metrics
            const total = tp + tn + fp + fn;
            const accuracy = total > 0 ? ((tp + tn) / total * 100) : 0;
            const recall = tp + fn > 0 ? (tp / (tp + fn) * 100) : 0;
            const fpr = fp + tn > 0 ? (fp / (fp + tn) * 100) : 0;
            const precision = tp + fp > 0 ? (tp / (tp + fp) * 100) : 0;

            document.getElementById('accuracy').textContent = accuracy.toFixed(0) + '%';
            document.getElementById('recall').textContent = recall.toFixed(0) + '%';
            document.getElementById('fpr').textContent = fpr.toFixed(0) + '%';
            document.getElementById('precision').textContent = precision.toFixed(0) + '%';

            // Update clinical interpretation
            document.getElementById('accuracyText').textContent = accuracy.toFixed(0) + '%';
            document.getElementById('recallText').textContent = recall.toFixed(0) + '%';
            document.getElementById('fprText').textContent = fpr.toFixed(0) + '%';

            // Highlight metrics that changed significantly
            highlightMetric('recallCard', recall);
            highlightMetric('precisionCard', precision);

            // Update ROC curve
            drawROCCurve(fpr / 100, recall / 100);
        }

        function highlightMetric(cardId, value) {
            const card = document.getElementById(cardId);
            card.classList.remove('highlight');
            // Add highlight animation
            setTimeout(() => card.classList.add('highlight'), 10);
        }

        function calculateROCPoints() {
            const points = [];
            const totalPositive = patients.filter(p => p.hasPneumonia).length;
            const totalNegative = patients.filter(p => !p.hasPneumonia).length;

            // Calculate TPR and FPR for thresholds from 0 to 100
            for (let t = 0; t <= 100; t += 2) {
                let tp = 0, fp = 0;
                patients.forEach(patient => {
                    if (patient.score >= t) {
                        if (patient.hasPneumonia) tp++;
                        else fp++;
                    }
                });
                const tpr = totalPositive > 0 ? tp / totalPositive : 0;
                const fpr = totalNegative > 0 ? fp / totalNegative : 0;
                points.push({ fpr, tpr, threshold: t });
            }
            return points;
        }

        function calculateAUC(points) {
            // Sort by FPR
            const sorted = [...points].sort((a, b) => a.fpr - b.fpr);
            let auc = 0;
            for (let i = 1; i < sorted.length; i++) {
                const width = sorted[i].fpr - sorted[i-1].fpr;
                const avgHeight = (sorted[i].tpr + sorted[i-1].tpr) / 2;
                auc += width * avgHeight;
            }
            return auc;
        }

        function drawROCCurve(currentFPR, currentTPR) {
            const canvas = document.getElementById('rocCanvas');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const padding = 30;
            const plotWidth = width - padding * 2;
            const plotHeight = height - padding * 2;

            // Clear canvas
            ctx.clearRect(0, 0, width, height);

            // Draw background
            ctx.fillStyle = '#f7fafc';
            ctx.fillRect(padding, padding, plotWidth, plotHeight);

            // Draw diagonal (random classifier)
            ctx.strokeStyle = '#cbd5e0';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            ctx.lineTo(width - padding, padding);
            ctx.stroke();
            ctx.setLineDash([]);

            // Draw axes
            ctx.strokeStyle = '#53565A';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();

            // Draw axis ticks and labels
            ctx.fillStyle = '#53565A';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';
            for (let i = 0; i <= 4; i++) {
                const val = i * 0.25;
                const x = padding + val * plotWidth;
                const y = height - padding - val * plotHeight;

                // X-axis ticks
                ctx.beginPath();
                ctx.moveTo(x, height - padding);
                ctx.lineTo(x, height - padding + 5);
                ctx.stroke();
                ctx.fillText(val.toFixed(2), x, height - padding + 15);

                // Y-axis ticks
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding - 5, y);
                ctx.stroke();
                ctx.textAlign = 'right';
                ctx.fillText(val.toFixed(2), padding - 8, y + 3);
                ctx.textAlign = 'center';
            }

            // Calculate and draw ROC curve
            const rocPoints = calculateROCPoints();
            const auc = calculateAUC(rocPoints);
            document.getElementById('aucValue').textContent = auc.toFixed(2);

            // Sort points by FPR for proper curve drawing
            rocPoints.sort((a, b) => a.fpr - b.fpr);

            // Draw ROC curve
            ctx.strokeStyle = '#8C1515';
            ctx.lineWidth = 2.5;
            ctx.beginPath();
            rocPoints.forEach((point, i) => {
                const x = padding + point.fpr * plotWidth;
                const y = height - padding - point.tpr * plotHeight;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();

            // Draw current operating point
            const currentX = padding + currentFPR * plotWidth;
            const currentY = height - padding - currentTPR * plotHeight;

            ctx.fillStyle = '#620059';
            ctx.beginPath();
            ctx.arc(currentX, currentY, 8, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(currentX, currentY, 4, 0, Math.PI * 2);
            ctx.fill();
        }

        const datasetExplanations = {
            separated: "<strong>Severe Cases:</strong> ICU patients with large lobar pneumonia and high fevers. The AI easily distinguishes these obvious cases from healthy patients. This represents ideal conditions — but an AI validated only on severe cases may struggle with your more subtle outpatients.",
            unseparated: "<strong>Subtle Cases:</strong> Outpatients with mild cough, low-grade fever, and early infiltrates. The sick and healthy patients look similar to the AI, making classification difficult. This is common in primary care screening where disease presents subtly.",
            imbalanced: "<strong>Rare Disease:</strong> TB screening in a low-prevalence population — only 10% have the disease. Even with good discrimination, the low prevalence means false positives can outnumber true positives. Pay close attention to precision when screening for rare conditions."
        };

        function setDataset(name, btn) {
            currentDataset = name;

            // Update button states
            document.querySelectorAll('.dataset-btn').forEach(b => {
                b.classList.remove('active');
            });
            if (btn) btn.classList.add('active');

            // Update explanation
            document.getElementById('datasetExplanation').innerHTML = datasetExplanations[name];

            generatePatients();
            updateVisualization();
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
