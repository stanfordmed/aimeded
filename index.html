<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore AI Diagnostic Performance</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Mobile Warning Popup -->
    <div class="mobile-popup-overlay" id="mobilePopup">
        <div class="mobile-popup">
            <h3>Best Viewed on a Larger Screen</h3>
            <p>This interactive tutorial works best on a tablet or desktop. Some features may be difficult to use on a small screen.</p>
            <button class="mobile-popup-btn" onclick="dismissMobilePopup()">Continue Anyway</button>
        </div>
    </div>

    <header class="site-header">
        <a href="https://med.stanford.edu/ai-in-meded.html" target="_blank">
            <img src="assets/logo.png" alt="Stanford Medicine - AI in Medical Education">
        </a>
    </header>
    <div class="container">
        <!-- Header -->
        <div class="card">
            <h1>Explore AI Diagnostic Performance</h1>
             <p class="authors">Vishnu Ravi, MD &bull; Alaa Youssef, PhD &bull; Aydin Zahedivash, MD &bull; Gabriel Tse, MD &bull; Jonathan Chen, MD, PhD</p>

            <div class="scenario-box">
                <h3>Why This Matters</h3>
                <p>AI-powered diagnostic tools are increasingly used in clinical settings. As a clinician, you need to understand how to interpret their performance metrics to make informed decisions about when to trust these tools and how to use them appropriately.</p>
                <p style="margin-top: 10px;">This tutorial uses a <strong>chest X-ray AI for pneumonia detection</strong> as an example. The same principles apply to any diagnostic AI tool.</p>
            </div>

            <!-- Main Learn/Experiment Tabs -->
            <div class="main-tabs-nav">
                <button class="main-tab-btn active" data-main-tab="experiment">Experiment</button>
                <button class="main-tab-btn" data-main-tab="learn">Review the Concepts</button>
            </div>
        </div>

        <!-- Experiment Tab Content -->
        <div class="main-tab-panel active" data-main-tab="experiment">
            <div class="card">
                <p style="margin-bottom: 20px;">Each dot represents a patient's chest X-ray. The AI assigns a <strong>confidence score</strong> (0-100%) for pneumonia. <strong>Drag the purple threshold line</strong> to set the cutoff. Patients scoring above the threshold (to its right) are flagged as "Pneumonia Detected." Watch how the confusion matrix and metrics change as you move the threshold. Try the three dataset buttons to see how AI performance differs with obvious vs. subtle cases, and high vs. low disease prevalence.</p>

            <div class="viz-row">
                <div class="viz-left">
                    <div class="dataset-selector">
                        <button class="dataset-btn active" onclick="setDataset('separated', this)">Severe Cases</button>
                        <button class="dataset-btn" onclick="setDataset('unseparated', this)">Subtle Cases</button>
                        <button class="dataset-btn" onclick="setDataset('imbalanced', this)">Low Prevalence</button>
                    </div>
                    <div class="dataset-explanation" id="datasetExplanation">
                        <strong>Severe Cases:</strong> ICU patients with large lobar pneumonia and high fevers. The AI easily distinguishes these obvious cases from healthy patients. This represents ideal conditions — but an AI validated only on severe cases may struggle with your more subtle outpatients.
                    </div>
                    <div class="prevalence-slider-container" id="prevalenceSliderContainer" style="display: none;">
                        <label class="prevalence-label">
                            <span>Disease Prevalence: <strong id="prevalenceValue">10%</strong></span>
                            <input type="range" id="prevalenceSlider" min="5" max="50" value="10" class="prevalence-slider">
                        </label>
                    </div>
                    <div class="threshold-viz-container">
                        <div class="distribution-chart" id="distributionChart">
                            <div class="zone-labels">
                                <span class="predicted-negative-zone">← AI predicts: No Pneumonia</span>
                                <span class="predicted-positive-zone">AI predicts: Pneumonia →</span>
                            </div>
                            <div class="chart-area" id="chartArea">
                                <div class="threshold-line" id="thresholdLine">
                                    <div class="threshold-label" id="thresholdLabel">Threshold: 50%</div>
                                </div>
                            </div>
                            <div class="chart-axis">
                                <span class="axis-label" style="left: 0%;">0%</span>
                                <span class="axis-label" style="left: 25%;">25%</span>
                                <span class="axis-label" style="left: 50%;">50%</span>
                                <span class="axis-label" style="left: 75%;">75%</span>
                                <span class="axis-label" style="left: 100%;">100%</span>
                            </div>
                        </div>
                        <p class="axis-title">AI Confidence Score (probability of pneumonia)</p>

                        <div class="legend">
                            <div class="legend-item">
                                <div class="legend-dot" style="background: #175E54;"></div>
                                Healthy patient
                            </div>
                            <div class="legend-item">
                                <div class="legend-dot" style="background: #B83A4B;"></div>
                                Patient with pneumonia
                            </div>
                        </div>
                    </div>
                </div>

                <div class="viz-right">
                    <!-- Confusion Matrix -->
                    <div class="matrix-container">
                        <div class="matrix-labels-top">
                            <div></div>
                            <div>AI: Pneumonia</div>
                            <div>AI: No Pneumonia</div>
                        </div>
                        <div class="matrix-row">
                            <div class="matrix-row-label">Actually Has<br>Pneumonia</div>
                            <div class="matrix-cell tp" id="tpCell">
                                <span class="label">True Positive</span>
                                <span class="count" id="tpCount">25</span>
                            </div>
                            <div class="matrix-cell fn" id="fnCell">
                                <span class="label">False Negative</span>
                                <span class="count" id="fnCount">5</span>
                            </div>
                        </div>
                        <div class="matrix-row">
                            <div class="matrix-row-label">Actually<br>Healthy</div>
                            <div class="matrix-cell fp" id="fpCell">
                                <span class="label">False Positive</span>
                                <span class="count" id="fpCount">10</span>
                            </div>
                            <div class="matrix-cell tn" id="tnCell">
                                <span class="label">True Negative</span>
                                <span class="count" id="tnCount">60</span>
                            </div>
                        </div>
                    </div>

                    <!-- ROC/PR Curve -->
                    <div class="curve-container">
                        <div class="curve-toggle">
                            <button class="curve-toggle-btn active" data-curve="roc">
                                ROC Curve
                                <span class="curve-btn-tooltip">Plots recall vs. false positive rate across thresholds. The diagonal represents random guessing.</span>
                            </button>
                            <button class="curve-toggle-btn" data-curve="pr">
                                PR Curve
                                <span class="curve-btn-tooltip">Plots precision vs. recall across thresholds. More informative than ROC when disease prevalence is low.</span>
                            </button>
                        </div>
                        <div class="curve-chart">
                            <canvas id="curveCanvas" width="300" height="240"></canvas>
                            <div class="curve-labels">
                                <span class="curve-ylabel" id="curveYLabel">Recall (TPR)</span>
                                <span class="curve-xlabel" id="curveXLabel">False Positive Rate</span>
                            </div>
                        </div>
                        <div class="auc-display">
                            AUC: <span id="aucValue">0.85</span>
                            <span class="auc-tooltip">Area Under the Curve: The probability that a randomly chosen patient with pneumonia scores higher than a randomly chosen healthy patient. 1.0 = perfect separation, 0.5 = random guessing.</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metrics -->
            <div class="metrics-grid">
                <div class="metric-card" id="accuracyCard">
                    <div class="metric-name">Accuracy</div>
                    <div class="metric-value" id="accuracy">85%</div>
                    <div class="metric-formula">(TP+TN) / Total</div>
                    <div class="metric-tooltip">The proportion of all predictions that were correct. While intuitive, accuracy can be misleading when disease prevalence is low.</div>
                </div>
                <div class="metric-card" id="recallCard">
                    <div class="metric-name">Recall (Sensitivity)</div>
                    <div class="metric-value" id="recall">83%</div>
                    <div class="metric-formula">TP / (TP+FN)</div>
                    <div class="metric-tooltip">The proportion of actual positive cases correctly identified. High recall means fewer missed diagnoses—critical when missing a disease is dangerous.</div>
                </div>
                <div class="metric-card" id="fprCard">
                    <div class="metric-name">False Positive Rate</div>
                    <div class="metric-value" id="fpr">14%</div>
                    <div class="metric-formula">FP / (FP+TN)</div>
                    <div class="metric-secondary">Specificity: <span id="specificity">86%</span></div>
                    <div class="metric-tooltip">The proportion of healthy patients incorrectly flagged as positive. A high FPR leads to unnecessary follow-up tests, anxiety, and costs. Specificity (1 − FPR) is the proportion correctly identified as healthy.</div>
                </div>
                <div class="metric-card" id="precisionCard">
                    <div class="metric-name">Precision (PPV)</div>
                    <div class="metric-value" id="precision">71%</div>
                    <div class="metric-formula">TP / (TP+FP)</div>
                    <div class="metric-tooltip">The proportion of positive predictions that were actually correct. Answers: "If the AI flags a patient, how likely are they to actually have the disease?"</div>
                </div>
                <div class="metric-card" id="f1Card">
                    <div class="metric-name">F1 Score</div>
                    <div class="metric-value" id="f1">77%</div>
                    <div class="metric-formula">2·P·R / (P+R)</div>
                    <div class="metric-tooltip">The harmonic mean of precision and recall. Useful when you need a single metric that balances catching cases (recall) with avoiding false alarms (precision).</div>
                </div>
                <div class="metric-card" id="npvCard">
                    <div class="metric-name">NPV</div>
                    <div class="metric-value" id="npv">92%</div>
                    <div class="metric-formula">TN / (TN+FN)</div>
                    <div class="metric-tooltip">Negative Predictive Value: If the AI says "no pneumonia," how likely is the patient actually healthy? Complements PPV/Precision.</div>
                </div>
            </div>

            <div class="implications-box">
                <h3>Clinical Interpretation</h3>
                <p id="clinicalInterpretation">
                    With this threshold, the AI correctly classifies <strong id="accuracyText">85%</strong> of all cases (accuracy)
                    and catches <strong id="recallText">83%</strong> of pneumonia cases (recall).
                    However, <strong id="fprText">14%</strong> of healthy patients receive false alarms (false positive rate).
                </p>
            </div>
            </div>

            <!-- Try It Yourself -->
            <div class="card">
                <h2>Try It Yourself</h2>
                <p style="margin-bottom: 20px;">Use the interactive visualization above to explore these clinical scenarios:</p>

                <div class="scenario-box" style="margin-bottom: 15px;">
                    <h3>1. Screening</h3>
                    <p>You don't want to send anyone with pneumonia home from the ED. Using <strong>"Severe Cases"</strong>, where would you set the threshold?</p>
                    <button class="show-answer-btn" onclick="toggleAnswer(this)">Show Answer</button>
                    <div class="answer-content">
                        <p><strong>Set a low threshold (~20-30%).</strong></p>
                        <p>For screening, you want <strong>high recall/sensitivity</strong>—catching as many true pneumonia cases as possible. Missing a case (false negative) could mean sending a sick patient home untreated.</p>
                        <p>The tradeoff: More false positives, meaning more healthy patients get flagged. But in the ED, it's safer to do additional testing on a false alarm than to miss real pneumonia.</p>
                    </div>
                </div>

                <div class="scenario-box" style="margin-bottom: 15px;">
                    <h3>2. Confirmatory</h3>
                    <p>You want to avoid unnecessary antibiotics and further workup. Using <strong>"Subtle Cases"</strong>, where would you set the threshold?</p>
                    <button class="show-answer-btn" onclick="toggleAnswer(this)">Show Answer</button>
                    <div class="answer-content">
                        <p><strong>Set a high threshold (~70-80%).</strong></p>
                        <p>For confirmatory testing, you want <strong>high precision (PPV)</strong>—when the AI says "pneumonia," you want to be confident it's correct before starting treatment.</p>
                        <p>The tradeoff: Lower recall (sensitivity) means you'll miss some cases. But if you're using this as a confirmatory test, patients who test negative can still be evaluated clinically or with other tests.</p>
                    </div>
                </div>

                <div class="scenario-box" style="margin-bottom: 15px;">
                    <h3>3. Low Prevalence</h3>
                    <p>Set the threshold to 50% in <strong>"Subtle Cases"</strong>, note the precision. Now switch to <strong>"Low Prevalence"</strong> at the same threshold. What happened to precision, and why?</p>
                    <button class="show-answer-btn" onclick="toggleAnswer(this)">Show Answer</button>
                    <div class="answer-content">
                        <p><strong>Precision drops significantly</strong> (from ~50% to ~20-30%).</p>
                        <p>This is the <strong>Bayesian insight</strong>: even with the same AI accuracy (similar AUC), precision depends on prevalence. When disease is rare, false positives outnumber true positives.</p>
                        <p>At 50% threshold in "Subtle Cases" (30% prevalence), a positive result might be ~50% likely to be true. In "Low Prevalence" (10% prevalence), that same positive result might only be ~25% likely to be true—because there are so few actual cases to find.</p>
                        <p><strong>Clinical implication:</strong> An AI validated in a high-prevalence ICU population may have poor precision when deployed in a low-prevalence outpatient clinic, even if the underlying discrimination is identical.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Learn Tab Content -->
        <div class="main-tab-panel" data-main-tab="learn">
            <div class="tabs-container" id="learn-content">
            <div class="tabs-nav">
                <button class="tab-btn active" data-tab="terms">The 4 Outcomes</button>
                <button class="tab-btn" data-tab="metrics">Key Metrics</button>
                <button class="tab-btn" data-tab="tradeoffs">Threshold Tradeoffs</button>
            </div>

            <!-- Confusion Matrix Explanation -->
            <div class="tab-panel active" data-tab="terms">
                <div class="tab-accordion-header">
                    <div class="tab-accordion-title">
                        <span class="tab-title">The 4 Outcomes</span>
                        <span class="tab-subtitle">TP, FP, TN, FN explained</span>
                    </div>
                    <span class="accordion-icon">+</span>
                </div>
                <div class="tab-content">
                    <p>When an AI tool makes a prediction, there are four possible outcomes based on whether the prediction was correct and what the actual condition is:</p>

                    <div class="quadrant-grid-container">
                        <div class="quadrant-labels-top">
                            <div></div>
                            <div>AI: Pneumonia</div>
                            <div>AI: No Pneumonia</div>
                        </div>
                        <div class="quadrant-row">
                            <div class="quadrant-row-label">Actually Has<br>Pneumonia</div>
                            <div class="quadrant-card tp-card">
                                <h4>True Positive (TP)</h4>
                                <p><strong>AI says:</strong> Pneumonia detected<br>
                                <strong>Reality:</strong> Patient has pneumonia<br>
                                <em>Correct alert — patient receives treatment</em></p>
                            </div>
                            <div class="quadrant-card fn-card">
                                <h4>False Negative (FN)</h4>
                                <p><strong>AI says:</strong> No pneumonia<br>
                                <strong>Reality:</strong> Patient has pneumonia<br>
                                <em>Missed case — delayed treatment</em></p>
                            </div>
                        </div>
                        <div class="quadrant-row">
                            <div class="quadrant-row-label">Actually<br>Healthy</div>
                            <div class="quadrant-card fp-card">
                                <h4>False Positive (FP)</h4>
                                <p><strong>AI says:</strong> Pneumonia detected<br>
                                <strong>Reality:</strong> Patient is healthy<br>
                                <em>False alarm — unnecessary treatment</em></p>
                            </div>
                            <div class="quadrant-card tn-card">
                                <h4>True Negative (TN)</h4>
                                <p><strong>AI says:</strong> No pneumonia<br>
                                <strong>Reality:</strong> Patient is healthy<br>
                                <em>Correct clearance — patient reassured</em></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="tab-panel" data-tab="metrics">
                <div class="tab-accordion-header">
                    <div class="tab-accordion-title">
                        <span class="tab-title">Key Metrics</span>
                        <span class="tab-subtitle">What each number means</span>
                    </div>
                    <span class="accordion-icon">+</span>
                </div>
                <div class="tab-content">
                    <p>These metrics help you evaluate how well the AI performs:</p>
                    <table style="width: 100%; border-collapse: collapse; margin: 15px 0;">
                        <thead>
                            <tr style="background: #edf2f7;">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #cbd5e0;">Metric</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #cbd5e0;">Question It Answers</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #cbd5e0;">Formula</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;"><strong>Accuracy</strong></td>
                                <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">Of all cases, how many did the AI classify correctly?</td>
                                <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; font-family: monospace;">(TP + TN) / Total</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;"><strong>Recall</strong><br><span style="color: #718096; font-size: 0.85em;">(Sensitivity, TPR)</span></td>
                                <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">Of all patients WITH pneumonia, how many did the AI catch?</td>
                                <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; font-family: monospace;">TP / (TP + FN)</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;"><strong>False Positive Rate</strong><br><span style="color: #718096; font-size: 0.85em;">(FPR)</span></td>
                                <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">Of all HEALTHY patients, how many did the AI incorrectly flag?</td>
                                <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; font-family: monospace;">FP / (FP + TN)</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;"><strong>Precision</strong><br><span style="color: #718096; font-size: 0.85em;">(PPV)</span></td>
                                <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">If AI says "pneumonia," how likely is it actually pneumonia?</td>
                                <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; font-family: monospace;">TP / (TP + FP)</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;"><strong>F1 Score</strong></td>
                                <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">Overall balance between precision and recall (harmonic mean)</td>
                                <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; font-family: monospace;">2·P·R / (P + R)</td>
                            </tr>
                            <tr>
                                <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;"><strong>NPV</strong><br><span style="color: #718096; font-size: 0.85em;">(Negative Predictive Value)</span></td>
                                <td style="padding: 12px; border-bottom: 1px solid #e2e8f0;">If AI says "no pneumonia," how likely is the patient actually healthy?</td>
                                <td style="padding: 12px; border-bottom: 1px solid #e2e8f0; font-family: monospace;">TN / (TN + FN)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Understanding Tradeoffs -->
            <div class="tab-panel" data-tab="tradeoffs">
                <div class="tab-accordion-header">
                    <div class="tab-accordion-title">
                        <span class="tab-title">Threshold Tradeoffs</span>
                        <span class="tab-subtitle">Why you can't have it all</span>
                    </div>
                    <span class="accordion-icon">+</span>
                </div>
                <div class="tab-content">
                    <p>Notice what happens when you move the threshold:</p>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div style="background: #e8f4f2; padding: 20px; border-radius: 10px; border-left: 4px solid #175E54;">
                            <h3 style="color: #175E54; margin-bottom: 10px;">Lower Threshold (←)</h3>
                            <ul style="margin-left: 20px; color: #175E54;">
                                <li>More cases flagged as positive</li>
                                <li><strong>Higher recall</strong> — catch more true pneumonia</li>
                                <li><strong>Higher false positive rate</strong> — more false alarms</li>
                                <li>Fewer missed cases, more unnecessary workup</li>
                            </ul>
                        </div>
                        <div style="background: #fef5f5; padding: 20px; border-radius: 10px; border-left: 4px solid #8C1515;">
                            <h3 style="color: #8C1515; margin-bottom: 10px;">Higher Threshold (→)</h3>
                            <ul style="margin-left: 20px; color: #820000;">
                                <li>Fewer cases flagged as positive</li>
                                <li><strong>Lower recall</strong> — miss more true pneumonia</li>
                                <li><strong>Lower false positive rate</strong> — fewer false alarms</li>
                                <li>More missed cases, less unnecessary workup</li>
                            </ul>
                        </div>
                    </div>

                    <div class="scenario-box">
                        <h3>Clinical Context Matters</h3>
                        <p><strong>Emergency screening:</strong> Use a lower threshold. Missing pneumonia in a sick patient (false negative) is dangerous. Accept more false positives that can be ruled out with further testing.</p>
                        <p style="margin-top: 10px;"><strong>Confirmatory testing:</strong> Use a higher threshold. You want high confidence before initiating aggressive treatment. False positives lead to unnecessary interventions.</p>
                    </div>
                </div>
            </div>

            </div>
        </div>

    </div>

    <footer class="site-footer">
        <a href="https://github.com/stanfordmed/aimeded" target="_blank">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            View on GitHub
        </a>
    </footer>

    <script src="js/script.js"></script>
</body>
</html>
